<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>الملف الشخصي – ميركاتو | تسوق بذكاء، عش أفضل</title>
  <!-- أيقونة المفضلة -->
  <link rel="icon" href="favicon.ico" type="image/x-icon" />

  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-KPJ7ZG4R');</script>
  <!-- نهاية Google Tag Manager -->

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- خطوط Google لـ Cairo -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;700;800;900&display=swap" rel="stylesheet" />

  <!-- حزم Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithCustomToken, signInAnonymously, signOut, updatePassword, reauthenticateWithCredential, EmailAuthProvider, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // تكوين Firebase (يُفضل أن يكون من متغيرات البيئة في بيئة Canvas)
    const userProvidedFirebaseConfig = {
      apiKey: "AIzaSyCuttEadee0V2YOZHmG53a2Rck7AvFCFEM", // استبدل هذا بمفتاح API الفعلي الخاص بك إذا لزم الأمر
      authDomain: "mercato-2cf1d.firebaseapp.com",
      projectId: "mercato-2cf1d",
      storageBucket: "mercato-2cf1d.firebasestorage.app",
      messagingSenderId: "896887505927",
      appId: "1:896887505927:web:6cb474409bdcfdb1e216a2",
      measurementId: "G-4WNGK0W077"
    };

    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : userProvidedFirebaseConfig;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    window.mercatoAppId = appId;

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    window.firebaseApp = app;
    window.firebaseAuth = auth;
    window.firebaseFirestore = {
      dbInstance: db,
      getFirestore: getFirestore,
      doc: doc,
      getDoc: getDoc,
      setDoc: setDoc,
      serverTimestamp: serverTimestamp,
      onSnapshot: onSnapshot // مطلوب لرأس الصفحة للاستماع إلى تغييرات السلة
    };
    window.firebaseAuthInstance = auth; // جعل مثيل المصادقة متاحًا لتسجيل الخروج

    // إضافة وظائف Firebase Auth لتغيير كلمة المرور وإعادة تعيينها
    window.firebaseAuthFunctions = {
        updatePassword: updatePassword,
        reauthenticateWithCredential: reauthenticateWithCredential,
        EmailAuthProvider: EmailAuthProvider,
        sendPasswordResetEmail: sendPasswordResetEmail
    };

    async function initializeAuthForCanvas() {
      try {
        if (typeof __initial_auth_token !== 'undefined') {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("خطأ في تهيئة مصادقة Firebase:", error);
      }
    }
    initializeAuthForCanvas();

    onAuthStateChanged(auth, (user) => {
      const initialLoadingScreen = document.getElementById('initial-loading');
      if (initialLoadingScreen) {
        initialLoadingScreen.style.display = 'none';
      }

      if (!user) {
        window.location.href = 'login.html';
      } else {
        if (window.renderApp) {
          window.renderApp(user);
        }
      }
    });

    window.handleSignOut = async () => {
      try {
        await signOut(window.firebaseAuthInstance); // استخدام مثيل المصادقة المعروض عالميًا
        window.location.href = 'login.html';
      } catch (error) {
        console.error("حدث خطأ أثناء تسجيل الخروج: ", error);
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[1000]';
        modal.innerHTML = `
          <div class="bg-white p-2 rounded-sm shadow-md text-center max-w-[150px]">
            <h3 class="text-sm font-bold text-red-600 mb-2">خطأ في تسجيل الخروج</h3>
            <p class="text-xs text-gray-700">${error.message || "حدث خطأ أثناء تسجيل الخروج. يرجى المحاولة مرة أخرى."}</p>
            <button class="mt-2 bg-[#1A2C42] text-white px-2 py-1 text-xs rounded-sm hover:bg-gray-800 transition-colors" onclick="this.parentNode.parentNode.remove()">حسناً</button>
          </div>
        `;
        document.body.appendChild(modal);
      }
    };
  </script>

  <style>
    /* لوحة الألوان الفاخرة الجديدة (الوضع الليلي الدائم): */
    /* Primary Dark: #1A2C42 (كحلي عميق / أزرق داكن) */
    /* Accent Gold: #D4AF37 (ذهبي / برونزي) */
    /* Light Background (تستخدم الآن كلون نص): #F8F8F8 (رمادي فاتح جداً / كريمي) */
    /* Secondary Accent: #5A7D9D (أزرق باهت / تيل) */
    /* Background Darkest: #0F1A2A */
    /* Header Background Darker: #0B141F */
    /* Card Background Dark: #1F2E40 */
    /* Input/Border: #2C3E50 */

    body {
      font-family: 'Cairo', sans-serif;
      background: #0F1A2A; /* خلفية داكنة ثابتة */
      color: #F8F8F8; /* لون النص الأساسي الفاتح */
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      line-height: 1.6;
      text-align: right;
      font-size: 0.625rem; /* ~78% من 0.8rem، لتقليص العناصر الأخرى بشكل فعال */
    }

    /* أحجام الخطوط في Tailwind - للحفاظ على أحجام النصوص جيدة */
    .text-xs { font-size: 0.7rem; }
    .text-sm { font-size: 0.8rem; }
    .text-base { font-size: 0.9rem; }
    .text-lg { font-size: 1.05rem; }
    .text-xl { font-size: 1.25rem; }
    .text-2xl { font-size: 1.5rem; }
    .text-3xl { font-size: 1.875rem; }
    .text-4xl { font-size: 2.25rem; }
    .text-5xl { font-size: 2.5rem; }

    /* أنماط شاشة التحميل الأولية */
    #initial-loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #0F1A2A;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        color: #F8F8F8;
    }
    .loading-spinner {
        border: 3.6px solid #2C3E50;
        border-top: 3.6px solid #D4AF37;
        border-radius: 50%;
        width: 22.5px;
        height: 22.5px;
        animation: spin 1s linear infinite;
        margin-bottom: 6.75px;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* حاويات عامة لضمان ألا يوجد شريط تمرير أفقي */
    .container {
      max-width: 576px; /* للحفاظ على عرض الهاتف */
      margin: 0 auto;
      padding: 0 0.8rem;
    }

    /* أنماط خاصة بالرأس */
    .header-bg {
      background: #0B141F;
      border-bottom: 1px solid rgba(212, 175, 55, 0.5);
    }

    /* أزرار بلمسة ذهبية */
    .btn-primary {
      background-color: #D4AF37;
      color: #1A2C42;
      font-weight: 800;
      padding: 0.4rem 1.3rem;
      border-radius: 9999px;
      box-shadow: 0 2.5px 6.5px rgba(212, 175, 55, 0.4);
      transition: all 0.3s ease;
      font-size: 0.7rem;
    }
    .btn-primary:hover {
      background-color: #C29B27;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(212, 175, 55, 0.6);
    }
    .btn-secondary {
      background-color: transparent;
      border: 1px solid #D4AF37;
      color: #D4AF37;
      font-weight: 700;
      padding: 0.35rem 1.2rem;
      border-radius: 9999px;
      transition: all 0.3s ease;
      font-size: 0.7rem;
    }
    .btn-secondary:hover {
      background-color: #D4AF37;
      color: #1A2C42;
      transform: translateY(-0.7px);
      box-shadow: 0 1.5px 4.5px rgba(212, 175, 55, 0.3);
    }

    /* أنماط المودال المخصصة (بدلاً من alert) */
    .custom-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .custom-modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }
    .custom-modal-content {
      background-color: #1F2E40;
      color: #F8F8F8;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.4);
      max-width: 270px;
      width: 90%;
      text-align: center;
      transform: translateY(-12px);
      opacity: 0;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }
    .custom-modal-overlay.show .custom-modal-content {
      transform: translateY(0);
      opacity: 1;
    }
    .custom-modal-content .p-4 {
        padding: 10px;
        border-radius: 6px;
    }
    .custom-modal-content .text-2xl {
        font-size: 1.25rem;
    }
    .custom-modal-content .text-lg {
        font-size: 0.9rem;
    }
    .custom-modal-content .bg-green-100 { background-color: #38A169; }
    .custom-modal-content .text-green-700 { color: #D6FAE9; }
    .custom-modal-content .border-green-400 { border-color: #68D391; }
    .custom-modal-content .bg-red-100 { background-color: #C53030; }
    .custom-modal-content .text-red-700 { color: #FEE2E2; }
    .custom-modal-content .border-red-400 { border-color: #F6AD55; }
    .custom-modal-content .bg-[#1A2C42] { background-color: #D4AF37; color: #1A2C42; }
    .custom-modal-content .hover:bg-[#5A7D9D]:hover { background-color: #C29B27; }
    .custom-modal-content .shadow-lg { box-shadow: 0 4px 8px rgba(0,0,0,0.3); }

    /* أنماط زر العودة للأعلى */
    .scroll-to-top {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #D4AF37;
      color: #1A2C42;
      border-radius: 50%;
      padding: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
      z-index: 999;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    .scroll-to-top.show {
      opacity: 1;
      visibility: visible;
    }
    .scroll-to-top:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
    }
    .scroll-to-top svg {
      width: 17px;
      height: 17px;
      stroke-width: 2.5;
    }

    /* أنماط خاصة ببطاقة الملف الشخصي */
    .profile-card {
        background: #1F2E40; /* خلفية داكنة لبطاقة الملف الشخصي */
        color: #F8F8F8; /* نص فاتح */
        padding: 25px;
        border-radius: 18px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
    }
    /* تحديث: تكبير حقول الإدخال وجعل النص أسود */
    .profile-card input, .profile-card select {
        background: #F8F8F8; /* خلفية إدخال فاتحة */
        color: #000000; /* نص إدخال داكن جداً (أسود) */
        border: 1px solid #5A7D9D; /* حدود خفيفة */
        padding: 18px; /* زيادة حجم الحقل بشكل أكبر */
        border-radius: 8px;
        font-size: 1.2rem; /* تكبير حجم النص داخل الحقول */
        line-height: 1.5; /* لتحسين التباعد الرأسي للنص */
        height: auto; /* السماح للارتفاع بالتكيف مع المحتوى */
    }
    .profile-card input::placeholder, .profile-card select::placeholder {
        color: #A0AEC0; /* نص عنصر نائب أفتح */
    }
    .profile-card input:focus, .profile-card select:focus {
        border-color: #D4AF37; /* حدود ذهبية عند التركيز */
        box-shadow: 0 0 0 1px #D4AF37; /* حلقة تركيز ذهبية */
    }
    .profile-card .animate-spin {
        color: #F8F8F8; /* مؤشر تحميل أبيض */
    }
    /* أنماط أزرار التبويب */
    .tab-button {
      background-color: #2C3E50;
      color: #F8F8F8;
      padding: 10px 15px;
      border-radius: 8px;
      font-weight: bold;
      transition: all 0.3s ease;
      font-size: 0.8rem;
    }
    .tab-button:hover {
      background-color: #5A7D9D;
    }
    .tab-button.active {
      background-color: #D4AF37;
      color: #1A2C42;
      box-shadow: 0 4px 10px rgba(212, 175, 55, 0.4);
    }
    .tab-content-section {
      background: #1F2E40;
      border-radius: 12px;
      padding: 20px;
      margin-top: 15px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.4);
    }
    /* أنماط خاصة بقسم الأمان فقط */
    .tab-content-section.security-tab-content label { /* لتطبيق اللون الذهبي على العناوين فقط في قسم الأمان */
        color: #D4AF37;
        font-size: 1.1rem; /* تكبير الخط للنص نفسه */
    }
    .tab-content-section.security-tab-content p { /* لتطبيق اللون الذهبي على النصوص العادية في قسم الأمان */
        color: #D4AF37;
        font-size: 1rem; /* تكبير الخط للنص نفسه */
    }
    .tab-content-section.security-tab-content input {
        background: #D4AF37; /* جعل الخلفية ذهبية */
        color: #F8F8F8; /* جعل النص أبيض */
        padding: 18px; /* تكبير مربعات الإدخال */
        font-size: 1.2rem; /* تكبير الخط داخل مربعات الإدخال */
    }
    .tab-content-section.security-tab-content input::placeholder {
        color: rgba(248, 248, 248, 0.7); /* لون نص العنصر النائب ليتناسب مع الخلفية الذهبية */
    }
    .tab-content-section.security-tab-content input:focus {
        border-color: #F8F8F8; /* حدود بيضاء عند التركيز */
        box-shadow: 0 0 0 1px #F8F8F8; /* حلقة تركيز بيضاء */
    }
    /* نمط جديد لحاوية حقل كلمة المرور مع زر العين */
    .password-input-container {
        position: relative;
    }
    .password-toggle-button {
        position: absolute;
        left: 10px; /* المسافة من اليسار (لأن الاتجاه RTL) */
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        cursor: pointer;
        color: #5A7D9D; /* لون أيقونة العين */
        padding: 5px;
        border-radius: 50%;
        transition: color 0.2s ease;
    }
    .password-toggle-button:hover {
        color: #D4AF37; /* لون ذهبي عند التحويم */
    }
    .password-toggle-button svg {
        width: 24px; /* تكبير حجم أيقونة العين */
        height: 24px;
    }
  </style>
</head>
<body class="font-cairo antialiased overflow-x-hidden">

  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KPJ7ZG4R"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- نهاية Google Tag Manager (noscript) -->

  <div id="root" class="flex-grow flex flex-col">
    <!-- شاشة التحميل الأولية (تختفي عندما يتم تحميل التطبيق) -->
    <div id="initial-loading" class="flex flex-col items-center justify-center min-h-screen">
        <div class="loading-spinner"></div>
        <p class="text-xl text-gray-300 mt-2">جاري التحقق من تسجيل الدخول...</p>
    </div>
  </div>

  <!-- مكتبات React الأساسية -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const useState = React.useState;
    const useEffect = React.useEffect;
    const useCallback = React.useCallback;

    // مكون المودال المخصص لعرض الرسائل
    const CustomModal = ({ message, type, onClose }) => {
      const isSuccess = type === 'success';
      const title = isSuccess ? 'نجاح!' : 'خطأ!';
      const bgColorClass = isSuccess ? 'bg-green-600' : 'bg-red-600';
      const textColorClass = 'text-white';
      const borderColorClass = isSuccess ? 'border-green-400' : 'border-red-400';

      return (
        <div className="custom-modal-overlay show">
          <div className="custom-modal-content">
            <div className={`p-4 rounded-lg border ${bgColorClass} ${textColorClass} mb-3`}>
              <h3 className="text-xl font-bold mb-2">{title}</h3>
              <p className="text-sm">{message}</p>
            </div>
            <button
              onClick={onClose}
              className="bg-[#D4AF37] text-[#1A2C42] font-bold py-2 px-6 rounded-full hover:bg-[#C29B27] transition-colors duration-300 shadow-sm text-sm"
            >
              حسناً
            </button>
          </div>
        </div>
      );
    };

    // --- مكون الرأس (Header Component) ---
    const Header = ({ currentUser }) => {
      const [isLoggedIn, setIsLoggedIn] = useState(false);
      const [cartItemCount, setCartItemCount] = useState(0);

      useEffect(() => {
        setIsLoggedIn(!!currentUser);
      }, [currentUser]);

      // تأثير للاستماع إلى تغييرات سلة التسوق في Firestore
      useEffect(() => {
        let unsubscribeCart = () => {};
        if (currentUser && currentUser.uid && window.firebaseFirestore && window.firebaseFirestore.onSnapshot) {
          const userCartRef = window.firebaseFirestore.doc(
            window.firebaseFirestore.dbInstance,
            'artifacts',
            window.mercatoAppId,
            'users',
            currentUser.uid,
            'userCart',
            'items' // المسار إلى مستند السلة الذي يحتوي على مصفوفة العناصر
          );

          unsubscribeCart = window.firebaseFirestore.onSnapshot(userCartRef, (docSnap) => {
            if (docSnap.exists() && docSnap.data().items) {
              const items = docSnap.data().items;
              // حساب العدد الإجمالي للكميات في السلة
              setCartItemCount(items.reduce((total, item) => total + (item.quantity || 0), 0));
            } else {
              setCartItemCount(0);
            }
          }, (error) => {
            console.error("خطأ في جلب عناصر سلة التسوق:", error);
            // اختياريًا، عرض مودال هنا إذا فشل جلب السلة
          });
        } else {
          setCartItemCount(0); // إعادة تعيين عدد السلة إذا قام المستخدم بتسجيل الخروج
        }

        return () => unsubscribeCart(); // تنظيف المستمع عند إلغاء تحميل المكون
      }, [currentUser]); // إعادة التشغيل عند تغيير currentUser

      const handleLogout = () => {
        if (window.handleSignOut) {
          window.handleSignOut();
        }
      };

      return (
        <header className="header-bg text-white p-1.5 shadow-sm rounded-b-md relative z-50">
          <div className="container mx-auto flex flex-wrap items-center justify-between py-1">
            {/* الشعار والعنوان (يمين) */}
            <div className="flex items-center space-x-1.5 space-x-reverse">
              <img
                src="https://i.postimg.cc/kGPQ7cK1/Screenshot-Canva.jpg" /* Updated logo URL */
                alt="ميركاتو"
                className="w-auto h-8 object-contain rounded-sm shadow-xs border border-[#D4AF37]"
                onError={(e) => {
                  e.target.onerror = null;
                  e.target.src = 'https://placehold.co/32x16/1A2C42/D4AF37?text=ميركاتو';
                }}
              />
              <div className="flex flex-col">
                <h1 className="text-2xl font-extrabold text-white leading-tight">
                  ميركاتو
                </h1>
                <p className="text-xs text-[#D4AF37] mt-0.25 font-light tracking-wide">
                  أفضل العروض، بأقل جهد!
                </p>
              </div>
            </div>

            {/* قائمة التنقل الرئيسية (المنتصف) */}
            <nav className="flex items-center space-x-2 space-x-reverse text-xs font-semibold flex-grow justify-center">
              <a href="index.html" className="hover:text-[#D4AF37] transition-colors p-0.5 rounded-xs hover:bg-white hover:bg-opacity-10">
                الرئيسية
              </a>
              <a href="all-categories.html" className="hover:text-[#D4AF37] transition-colors p-0.5 rounded-xs hover:bg-white hover:bg-opacity-10">
                أقسامنا
              </a>
              <a href="daily-deals.html" className="hover:text-[#D4AF37] transition-colors p-0.5 rounded-xs hover:bg-white hover:bg-opacity-10">
                عروض اليوم
              </a>
              <a href="faq.html" className="hover:text-[#D4AF37] transition-colors p-0.5 rounded-xs hover:bg-white hover:bg-opacity-10">
                الأسئلة الشائعة
              </a>
              <a href="contact.html" className="hover:text-[#D4AF37] transition-colors p-0.5 rounded-xs hover:bg-white hover:bg-opacity-10">
                اتصل بنا
              </a>
            </nav>

            {/* أزرار السلة والملف الشخصي/الدخول (أقصى اليسار) */}
            <div className="flex items-center space-x-1.5 space-x-reverse">
              {/* زر السلة - يظهر دائمًا */}
              <a href="cart.html" className="relative p-1.5 rounded-full bg-[#5A7D9D] hover:bg-[#D4AF37] hover:text-[#1A2C42] transition-colors flex items-center justify-center text-white focus:outline-none focus:ring-1 focus:ring-[#D4AF37]" aria-label="السلة">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-shopping-cart"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57L23 4H5.2"/>
                </svg>
                {/* عدد المنتجات في السلة */}
                {cartItemCount > 0 && (
                  <span className="absolute -top-1 -left-1 bg-red-600 text-white text-[0.6rem] rounded-full px-1.5 py-0.5 font-bold leading-none">
                    {cartItemCount}
                  </span>
                )}
              </a>

              {isLoggedIn ? (
                // If user is logged in, show profile button only
                // Removed the profile.html link from here as per request
                <button
                    onClick={handleLogout}
                    className="flex items-center text-white font-bold py-1 px-2 rounded-full bg-red-700 hover:bg-red-800 transition-colors duration-300 shadow-xs text-xs"
                >
                    تسجيل الخروج
                </button>
              ) : (
                // If not logged in, show login and signup buttons
                <div className="flex space-x-1.5 space-x-reverse">
                  <a href="login.html" className="btn-secondary">
                    تسجيل الدخول
                  </a>
                  <a href="signup.html" className="btn-primary">
                    إنشاء حساب
                  </a>
                </div>
              )}
            </div>
          </div>
        </header>
      );
    };

    // --- مكون زر العودة للأعلى (Scroll to Top Button Component) ---
    const ScrollToTopButton = () => {
      const [isVisible, setIsVisible] = useState(false);

      const toggleVisibility = () => {
        if (window.pageYOffset > 300) {
          setIsVisible(true);
        } else {
          setIsVisible(false);
        }
      };

      const scrollToTop = () => {
        window.scrollTo({
          top: 0,
          behavior: 'smooth'
        });
      };

      useEffect(() => {
        window.addEventListener('scroll', toggleVisibility);
        return () => window.removeEventListener('scroll', toggleVisibility);
      }, []);

      return (
        <button
          onClick={scrollToTop}
          className={`scroll-to-top ${isVisible ? 'show' : ''}`}
          aria-label="العودة للأعلى"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-arrow-up"><path d="m5 12 7-7 7 7"/><path d="M12 19V5"/></svg>
        </button>
      );
    };

    // --- مكون التذييل (Footer Component) ---
    const Footer = () => {
      return (
        <footer className="bg-[#0B141F] text-white py-6 px-1.5 mt-10 rounded-t-md shadow-inner-dark relative z-30">
          <div className="container mx-auto grid grid-cols-1 md:grid-cols-3 gap-2.5 text-center md:text-right">
            {/* Removed Contact Information */}
            {/* Removed Quick Links */}

            {/* تابعنا */}
            <div className="animate-fade-in-up animation-delay-400 col-span-full md:col-span-1"> {/* Adjusted column span for centering */}
              <h3 className="text-base font-bold mb-1.5 text-[#D4AF37]">تابعنا</h3>
              <div className="flex justify-center md:justify-end space-x-2.5 space-x-reverse">
                <a
                  href="https://www.tiktok.com/@mercato.0"
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-gray-400 hover:text-[#D4AF37] transition-colors transform hover:scale-110 duration-300 text-xs"
                  aria-label="TikTok"
                >
                  TIKTOK
                </a>
                <a
                  href="https://www.instagram.com/mercato.0?igsh=MWRvangxbHdqcXA0bQ=="
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-gray-400 hover:text-[#D4AF37] transition-colors transform hover:scale-110 duration-300 text-xs"
                  aria-label="Instagram"
                >
                  Instagram
                </a>
                <a
                  href="https://t.me/mercato00"
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-gray-400 hover:text-[#D4AF37] transition-colors transform hover:scale-110 duration-300 text-xs"
                  aria-label="Telegram"
                >
                  Telegram
                </a>
                <a
                  href="https://www.facebook.com/yourpage" /* Placeholder for Facebook link */
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-gray-400 hover:text-[#D4AF37] transition-colors transform hover:scale-110 duration-300 text-xs"
                  aria-label="Facebook"
                >
                  FACEBOOK
                </a>
              </div>
            </div>
          </div>
          <div className="border-t border-gray-600 mt-3.5 pt-3.5 text-center text-gray-500 text-xs">
            <p>&copy; 2025 ميركاتو. جميع الحقوق محفوظة.</p>
            <p className="mt-1">مصمم بحب لتقديم أفضل تجربة تسوق.</p>
          </div>
        </footer>
      );
    };

    // قائمة الدول المحددة
    const countries = [
        { code: 'SA', name: 'السعودية' },
        { code: 'IQ', name: 'العراق' },
        { code: 'JO', name: 'الأردن' },
        { code: 'KW', name: 'الكويت' },
        { code: 'BH', name: 'البحرين' },
        { code: 'QA', name: 'قطر' },
        { code: 'OM', name: 'عمان' },
        { code: 'EG', name: 'مصر' },
        { code: 'AE', name: 'الإمارات' },
    ];

    // --- مكون صفحة الملف الشخصي (ProfilePage) ---
    const ProfilePage = ({ currentUser }) => {
      const [userProfile, setUserProfile] = useState(null);
      const [editMode, setEditMode] = useState(false); // وضع التحرير للبيانات الأساسية
      const [editedName, setEditedName] = useState('');
      const [selectedCountry, setSelectedCountry] = useState('');
      const [loading, setLoading] = useState(true);
      const [modal, setModal] = useState(null);
      const [isUpdating, setIsUpdating] = useState(false);
      const [activeTab, setActiveTab] = useState('profile'); // tabs: profile, security

      // New states for password change/reset
      const [oldPassword, setOldPassword] = useState('');
      const [newPassword, setNewPassword] = useState('');
      const [confirmNewPassword, setConfirmNewPassword] = useState('');
      const [forgotPasswordMode, setForgotPasswordMode] = useState(false); // true if user clicked "Forgot Password?"
      const [resetEmailSent, setResetEmailSent] = useState(false); // true after sending reset email
      const [verificationCode, setVerificationCode] = useState(''); // For the "code" input
      const [isPasswordChanging, setIsPasswordChanging] = useState(false);
      const [isSendingResetEmail, setIsSendingResetEmail] = useState(false);
      const [isVerifyingCode, setIsVerifyingCode] = useState(false);

      // States for password visibility
      const [showOldPassword, setShowOldPassword] = useState(false);
      const [showNewPassword, setShowNewPassword] = useState(false);
      const [showConfirmNewPassword, setShowConfirmNewPassword] = useState(false);
      const [showResetNewPassword, setShowResetNewPassword] = useState(false);
      const [showResetConfirmNewPassword, setShowResetConfirmNewPassword] = useState(false);


      const [cartItems, setCartItems] = useState([]); // لحفظ عناصر السلة

      // تأثير لجلب ملف تعريف المستخدم
      useEffect(() => {
        const fetchUserProfile = async () => {
          if (!currentUser || !currentUser.uid || !window.firebaseFirestore || !window.mercatoAppId) {
            setModal({ message: 'خطأ: بيانات المستخدم غير متوفرة أو Firebase غير مهيأ.', type: 'error', onClose: () => setModal(null) });
            setLoading(false);
            return;
          }

          setLoading(true);
          try {
            const dbInstance = window.firebaseFirestore.getFirestore();
            // مسار Firestore لملف تعريف المستخدم
            const userDocRef = window.firebaseFirestore.doc(dbInstance, 'artifacts', window.mercatoAppId, 'users', currentUser.uid, 'userProfiles', 'profile');
            const userDocSnap = await window.firebaseFirestore.getDoc(userDocRef);

            if (userDocSnap.exists()) {
              const data = userDocSnap.data();
              setUserProfile(data);
              setEditedName(data.name || ''); // تعيين الاسم القابل للتحرير
              // إذا كانت الدولة موجودة في البيانات، استخدمها، وإلا فاستخدم "لم يتم الاختيار"
              setSelectedCountry(data.country && countries.some(c => c.code === data.country) ? data.country : 'لم يتم الاختيار');
              // تخزين الدولة في localStorage لتعميمها على مستوى التطبيق
              if (data.country) {
                localStorage.setItem('mercato_selected_country', data.country);
              }
            } else {
              // إذا لم يكن هناك ملف شخصي، قم بإنشاء واحد أساسي
              await window.firebaseFirestore.setDoc(userDocRef, {
                email: currentUser.email,
                createdAt: window.firebaseFirestore.serverTimestamp(),
                country: 'لم يتم الاختيار', // قيمة افتراضية
                name: '', // اسم افتراضي فارغ
              });
              setUserProfile({ email: currentUser.email, country: 'لم يتم الاختيار', name: '' });
              setEditedName('');
              setSelectedCountry('لم يتم الاختيار');
              localStorage.setItem('mercato_selected_country', 'لم يتم الاختيار'); // تحديث localStorage
              setModal({ message: 'تم إنشاء ملفك الشخصي بنجاح! يرجى إكمال بياناتك.', type: 'success', onClose: () => setModal(null) });
            }
          } catch (error) {
            console.error("خطأ في جلب أو إنشاء ملف تعريف المستخدم:", error);
            setModal({ message: 'تعذر تحميل أو إنشاء ملفك الشخصي. يرجى المحاولة مرة أخرى.', type: 'error', onClose: () => setModal(null) });
          } finally {
            setLoading(false);
          }
        };

        fetchUserProfile();
      }, [currentUser]); // إعادة التشغيل عند تغيير كائن currentUser

      // تأثير لجلب عناصر السلة في الوقت الفعلي
      useEffect(() => {
        let unsubscribeCart = () => {};
        if (currentUser && currentUser.uid && window.firebaseFirestore && window.firebaseFirestore.onSnapshot) {
          const userCartDocRef = window.firebaseFirestore.doc(
            window.firebaseFirestore.dbInstance,
            'artifacts',
            window.mercatoAppId,
            'users',
            currentUser.uid,
            'userCart', // هذا هو اسم المجموعة
            'items' // هذا هو معرف المستند الفعلي داخل userCart الذي يحتوي على مصفوفة العناصر
          );

          unsubscribeCart = window.firebaseFirestore.onSnapshot(userCartDocRef, (docSnap) => {
            if (docSnap.exists() && docSnap.data().items) {
              setCartItems(docSnap.data().items);
            } else {
              setCartItems([]);
            }
          }, (err) => {
            console.error("خطأ في جلب عناصر السلة لصفحة الملف الشخصي:", err);
            // لا نعرض رسالة خطأ للمستخدم هنا، لأن صفحة السلة الرئيسية هي المسؤولة عن ذلك
          });
        } else {
          setCartItems([]);
        }

        return () => unsubscribeCart(); // إزالة المستمع عند إلغاء تحميل المكون
      }, [currentUser]); // إعادة التشغيل عند تغيير حالة المستخدم


      const handleCountryChange = (e) => {
        setSelectedCountry(e.target.value);
      };

      const handleNameChange = (e) => {
        setEditedName(e.target.value);
      };

      const handleUpdateProfile = async () => {
        if (!currentUser || !currentUser.uid || !window.firebaseFirestore || !window.mercatoAppId) {
          setModal({ message: 'خطأ: بيانات المستخدم غير متوفرة أو Firebase غير مهيأ.', type: 'error', onClose: () => setModal(null) });
          return;
        }

        if (!editedName.trim()) {
            setModal({ message: 'الرجاء إدخال الاسم.', type: 'error', onClose: () => setModal(null) });
            return;
        }

        if (selectedCountry === 'لم يتم الاختيار' || selectedCountry === '') {
            setModal({ message: 'الرجاء اختيار دولة صحيحة لتحديث ملفك الشخصي.', type: 'error', onClose: () => setModal(null) });
            return;
        }

        setIsUpdating(true);
        try {
          const dbInstance = window.firebaseFirestore.getFirestore();
          const userDocRef = window.firebaseFirestore.doc(dbInstance, 'artifacts', window.mercatoAppId, 'users', currentUser.uid, 'userProfiles', 'profile');
          await window.firebaseFirestore.setDoc(userDocRef, {
            name: editedName,
            country: selectedCountry
          }, { merge: true });

          setUserProfile(prev => ({ ...prev, name: editedName, country: selectedCountry }));
          localStorage.setItem('mercato_selected_country', selectedCountry); // تحديث localStorage
          setEditMode(false); // الخروج من وضع التحرير بعد التحديث
          setModal({ message: 'تم تحديث ملفك الشخصي بنجاح!', type: 'success', onClose: () => setModal(null) });
        } catch (error) {
          console.error("خطأ في تحديث الملف الشخصي:", error);
          setModal({ message: 'فشل تحديث الملف الشخصي. يرجى المحاولة مرة أخرى.', type: 'error', onClose: () => setModal(null) });
        } finally {
          setIsUpdating(false);
        }
      };

      // Function to handle password change (when user knows old password)
      const handleChangePassword = async () => {
        if (!currentUser || !currentUser.email || !window.firebaseAuthInstance || !window.firebaseAuthFunctions) {
          setModal({ message: 'خطأ في المصادقة: المستخدم غير متوفر أو وظائف Firebase غير مهيأة.', type: 'error', onClose: () => setModal(null) });
          return;
        }
        if (!oldPassword || !newPassword || !confirmNewPassword) {
          setModal({ message: 'الرجاء تعبئة جميع حقول كلمة المرور.', type: 'error', onClose: () => setModal(null) });
          return;
        }
        if (newPassword !== confirmNewPassword) {
          setModal({ message: 'كلمة المرور الجديدة وتأكيدها غير متطابقين.', type: 'error', onClose: () => setModal(null) });
          return;
        }
        if (newPassword.length < 6) {
          setModal({ message: 'يجب أن تكون كلمة المرور الجديدة 6 أحرف على الأقل.', type: 'error', onClose: () => setModal(null) });
          return;
        }

        setIsPasswordChanging(true);
        try {
          // إعادة مصادقة المستخدم قبل تغيير كلمة المرور
          const credential = window.firebaseAuthFunctions.EmailAuthProvider.credential(currentUser.email, oldPassword);
          await window.firebaseAuthFunctions.reauthenticateWithCredential(currentUser, credential);
          // تحديث كلمة المرور
          await window.firebaseAuthFunctions.updatePassword(currentUser, newPassword);
          setModal({ message: 'تم تغيير كلمة المرور بنجاح!', type: 'success', onClose: () => setModal(null) });
          setOldPassword('');
          setNewPassword('');
          setConfirmNewPassword('');
        } catch (error) {
          console.error("خطأ في تغيير كلمة المرور:", error);
          let errorMessage = 'فشل تغيير كلمة المرور. يرجى المحاولة مرة أخرى.';
          if (error.code === 'auth/wrong-password') {
            errorMessage = 'كلمة المرور القديمة غير صحيحة.';
          } else if (error.code === 'auth/requires-recent-login') {
            errorMessage = 'الرجاء تسجيل الدخول مرة أخرى قبل تغيير كلمة المرور (لأسباب أمنية).';
          }
          setModal({ message: errorMessage, type: 'error', onClose: () => setModal(null) });
        } finally {
          setIsPasswordChanging(false);
        }
      };

      // Function to initiate password reset (send email)
      const handleSendPasswordResetEmail = async () => {
        if (!currentUser || !currentUser.email || !window.firebaseAuthFunctions || !window.firebaseAuthFunctions.sendPasswordResetEmail) {
          setModal({ message: 'خطأ: البريد الإلكتروني للمستخدم غير متوفر أو وظائف Firebase غير مهيأة.', type: 'error', onClose: () => setModal(null) });
          return;
        }
        setIsSendingResetEmail(true);
        try {
          await window.firebaseAuthFunctions.sendPasswordResetEmail(window.firebaseAuthInstance, currentUser.email);
          setModal({ message: `تم إرسال رابط إعادة تعيين كلمة المرور إلى ${currentUser.email}. يرجى التحقق من بريدك الوارد.`, type: 'success', onClose: () => setModal(null) });
          setResetEmailSent(true); // Indicate that email has been sent
          setVerificationCode(''); // Clear code field
          setNewPassword(''); // Clear new password field
          setConfirmNewPassword(''); // Clear confirm new password field
        } catch (error) {
          console.error("خطأ في إرسال بريد إعادة تعيين كلمة المرور:", error);
          let errorMessage = 'فشل إرسال بريد إعادة تعيين كلمة المرور. يرجى المحاولة مرة أخرى.';
          if (error.code === 'auth/user-not-found') {
            errorMessage = 'لا يوجد حساب بهذا البريد الإلكتروني.';
          }
          setModal({ message: errorMessage, type: 'error', onClose: () => setModal(null) });
        } finally {
          setIsSendingResetEmail(false);
        }
      };

      // Placeholder for verifying code and resetting password (UI only for now)
      const handleVerifyCodeAndResetPassword = async () => {
        // ملاحظة: في تطبيق Firebase حقيقي، تتضمن هذه العملية عادةً:
        // 1. قيام المستخدم بالنقر على رابط في بريده الإلكتروني يحتوي على oobCode.
        // 2. يقوم التطبيق بعد ذلك باستخدام `auth.verifyPasswordResetCode(oobCode)` للتحقق من الرمز.
        // 3. ثم `auth.confirmPasswordReset(oobCode, newPassword)` لتعيين كلمة المرور الجديدة.
        // نظرًا لأن المستخدم طلب إدخال "رمز" داخل التطبيق، سنقوم بمحاكاته لواجهة المستخدم.
        // التنفيذ الفعلي للتحقق من هذا الرمز وإعادة تعيين كلمة المرور داخل التطبيق أكثر تعقيدًا
        // ويتطلب عادةً Firebase Admin SDK أو Cloud Functions.
        
        if (!verificationCode || !newPassword || !confirmNewPassword) {
          setModal({ message: 'الرجاء تعبئة جميع الحقول: رمز التحقق وكلمة المرور الجديدة وتأكيدها.', type: 'error', onClose: () => setModal(null) });
          return;
        }
        if (newPassword !== confirmNewPassword) {
          setModal({ message: 'كلمة المرور الجديدة وتأكيدها غير متطابقين.', type: 'error', onClose: () => setModal(null) });
          return;
        }
        if (newPassword.length < 6) {
          setModal({ message: 'يجب أن تكون كلمة المرور الجديدة 6 أحرف على الأقل.', type: 'error', onClose: () => setModal(null) });
          return;
        }

        setIsVerifyingCode(true);
        // محاكاة استدعاء API
        setTimeout(() => {
            setModal({ message: 'تم إرسال طلب إعادة تعيين كلمة المرور. يرجى التحقق من بريدك الإلكتروني لإكمال العملية.', type: 'success', onClose: () => setModal(null) });
            setVerificationCode('');
            setNewPassword('');
            setConfirmNewPassword('');
            setForgotPasswordMode(false); // الخروج من وضع "نسيت كلمة المرور"
            setResetEmailSent(false); // إعادة تعيين حالة إرسال البريد الإلكتروني
            setIsVerifyingCode(false);
        }, 1500);
      };

      const handleSignOut = () => {
        if (window.handleSignOut) {
          window.handleSignOut();
        }
      };

      if (loading) {
        return (
          <div className="min-h-screen flex items-center justify-center bg-[#0F1A2A] p-2.5">
            <div className="flex flex-col items-center">
              <div className="loading-spinner"></div>
              <p className="text-xl text-gray-300 mt-2">جاري تحميل الملف الشخصي...</p>
            </div>
          </div>
        );
      }

      return (
        <div dir="rtl" className="flex-grow flex flex-col">
          <Header currentUser={currentUser} />
          
          <main className="container mx-auto my-10 px-2.5 relative z-30 flex-grow">
            <h2 className="text-4xl font-extrabold text-[#F8F8F8] text-center mb-6 mt-12">
              ملفك الشخصي
            </h2>

            {/* أزرار التبويب */}
            <div className="flex justify-center space-x-3 space-x-reverse mb-6">
              <button
                onClick={() => setActiveTab('profile')}
                className={`tab-button ${activeTab === 'profile' ? 'active' : ''}`}
              >
                المعلومات الشخصية
              </button>
              <button
                onClick={() => setActiveTab('security')}
                className={`tab-button ${activeTab === 'security' ? 'active' : ''}`}
              >
                الأمان
              </button>
            </div>

            {/* محتوى التبويبات */}
            {activeTab === 'profile' && (
              <div className="profile-card rounded-xl shadow-xl p-6 w-full max-w-xs mx-auto">
                <div className="mb-4">
                    <p className="text-base font-semibold text-white mb-1">معرف المستخدم (UID):</p>
                    <p className="text-sm text-[#9EC0D8] break-all">{currentUser?.uid || 'غير متاح'}</p>
                </div>

                <div className="mb-4">
                    <p className="text-base font-semibold text-white mb-1">البريد الإلكتروني:</p>
                    <p className="text-sm text-[#9EC0D8] break-all">{userProfile?.email || 'غير متاح'}</p>
                </div>

                <div className="mb-4">
                    <p className="text-base font-semibold text-white mb-1">تاريخ إنشاء الحساب:</p>
                    <p className="text-sm text-[#9EC0D8] break-all">
                      {userProfile?.createdAt ? new Date(userProfile.createdAt.seconds * 1000).toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' }) : 'غير متاح'}
                    </p>
                </div>

                <div className="mb-4">
                    <label className="block text-base font-semibold text-white mb-1" htmlFor="name-input">
                        الاسم الكامل:
                    </label>
                    {editMode ? (
                        <input
                            type="text"
                            id="name-input"
                            value={editedName}
                            onChange={handleNameChange}
                            className="w-full"
                            placeholder="أدخل اسمك الكامل"
                            required
                        />
                    ) : (
                        <p className="text-sm text-[#9EC0D8] break-all">{userProfile?.name || 'لم يتم إدخال الاسم'}</p>
                    )}
                </div>

                <div className="mb-6">
                    <label className="block text-base font-semibold text-white mb-1" htmlFor="country-select">
                        البلد:
                    </label>
                    {editMode ? (
                        <div className="relative">
                            <select
                                id="country-select"
                                value={selectedCountry}
                                onChange={handleCountryChange}
                                className="block w-full p-2.5 rounded-lg border border-[#5A7D9D] focus:border-[#D4AF37] focus:ring-1 focus:ring-[#D4AF37] transition-all duration-300 text-sm bg-[#2C3E50] text-[#F8F8F8] appearance-none"
                            >
                                <option value="لم يتم الاختيار" disabled>اختر دولتك</option>
                                {countries.map((country) => (
                                    <option key={country.code} value={country.code}>
                                        {country.name}
                                    </option>
                                ))}
                            </select>
                            <div className="pointer-events-none absolute inset-y-0 left-0 flex items-center px-2 text-[#D4AF37]">
                                <svg className="fill-current h-3 w-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 6.757 7.586 5.343 9z"/></svg>
                            </div>
                        </div>
                    ) : (
                        <p className="text-sm text-[#9EC0D8] break-all">
                          {/* عرض اسم الدولة الكامل بدلاً من الرمز */}
                          {countries.find(c => c.code === userProfile?.country)?.name || 'لم يتم الاختيار'}
                        </p>
                    )}
                </div>

                {editMode ? (
                    <button
                        onClick={handleUpdateProfile}
                        className="btn-primary w-full text-base py-2.5 flex items-center justify-center space-x-1.5 space-x-reverse mb-4"
                        disabled={isUpdating}
                    >
                        {isUpdating ? (
                        <>
                            <svg className="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span>جاري التحديث...</span>
                        </>
                        ) : (
                        <span>حفظ التغييرات</span>
                        )}
                    </button>
                ) : (
                    <button
                        onClick={() => setEditMode(true)}
                        className="btn-secondary w-full text-base py-2.5 mb-4"
                    >
                        تعديل الملف الشخصي
                    </button>
                )}

                <button
                    onClick={handleSignOut}
                    className="w-full text-base py-2.5 px-6 rounded-full bg-red-700 text-white hover:bg-red-800 transition-colors duration-300 shadow-sm"
                >
                    تسجيل الخروج
                </button>
              </div>
            )}

            {activeTab === 'security' && (
              <div className="tab-content-section security-tab-content w-full max-w-xs mx-auto"> {/* إضافة security-tab-content class هنا */}
                <h3 className="text-xl font-bold text-[#D4AF37] mb-4 text-center">تغيير كلمة المرور</h3>
                {/* التحقق مما إذا كان المستخدم قد سجل الدخول باستخدام بريد إلكتروني وكلمة مرور */}
                {currentUser?.providerData && currentUser.providerData[0]?.providerId === 'password' ? (
                    <>
                        {!forgotPasswordMode ? (
                            <>
                                <div className="mb-4 password-input-container">
                                    <label className="block font-semibold mb-1" htmlFor="old-password">
                                        كلمة المرور القديمة:
                                    </label>
                                    <input
                                        type={showOldPassword ? "text" : "password"}
                                        id="old-password"
                                        value={oldPassword}
                                        onChange={(e) => setOldPassword(e.target.value)}
                                        className="w-full"
                                        placeholder="أدخل كلمة المرور القديمة"
                                        required
                                        autoComplete="off"
                                    />
                                    <button
                                        type="button"
                                        onClick={() => setShowOldPassword(prev => !prev)}
                                        className="password-toggle-button"
                                    >
                                        {showOldPassword ? (
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-eye-off"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.54 18.54 0 0 1 2.21-3.02M5.07 5.07A10.91 10.91 0 0 1 8 4c7 0 11 8 11 8a18.54 18.54 0 0 1-2.21 3.02M9.36 10.64a3 3 0 1 0 4.24 4.24M1 1l22 22"/></svg>
                                        ) : (
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-eye"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                                        )}
                                    </button>
                                </div>
                                <div className="mb-4 password-input-container">
                                    <label className="block font-semibold mb-1" htmlFor="new-password">
                                        كلمة المرور الجديدة:
                                    </label>
                                    <input
                                        type={showNewPassword ? "text" : "password"}
                                        id="new-password"
                                        value={newPassword}
                                        onChange={(e) => setNewPassword(e.target.value)}
                                        className="w-full"
                                        placeholder="أدخل كلمة المرور الجديدة"
                                        required
                                        autoComplete="new-password"
                                    />
                                    <button
                                        type="button"
                                        onClick={() => setShowNewPassword(prev => !prev)}
                                        className="password-toggle-button"
                                    >
                                        {showNewPassword ? (
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-eye-off"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.54 18.54 0 0 1 2.21-3.02M5.07 5.07A10.91 10.91 0 0 1 8 4c7 0 11 8 11 8a18.54 18.54 0 0 1-2.21 3.02M9.36 10.64a3 3 0 1 0 4.24 4.24M1 1l22 22"/></svg>
                                        ) : (
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-eye"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                                        )}
                                    </button>
                                </div>
                                <div className="mb-6 password-input-container">
                                    <label className="block font-semibold mb-1" htmlFor="confirm-new-password">
                                        تأكيد كلمة المرور الجديدة:
                                    </label>
                                    <input
                                        type={showConfirmNewPassword ? "text" : "password"}
                                        id="confirm-new-password"
                                        value={confirmNewPassword}
                                        onChange={(e) => setConfirmNewPassword(e.target.value)}
                                        className="w-full"
                                        placeholder="أعد إدخال كلمة المرور الجديدة"
                                        required
                                        autoComplete="new-password"
                                    />
                                    <button
                                        type="button"
                                        onClick={() => setShowConfirmNewPassword(prev => !prev)}
                                        className="password-toggle-button"
                                    >
                                        {showConfirmNewPassword ? (
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-eye-off"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.54 18.54 0 0 1 2.21-3.02M5.07 5.07A10.91 10.91 0 0 1 8 4c7 0 11 8 11 8a18.54 18.54 0 0 1-2.21 3.02M9.36 10.64a3 3 0 1 0 4.24 4.24M1 1l22 22"/></svg>
                                        ) : (
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-eye"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                                        )}
                                    </button>
                                </div>
                                <button
                                    onClick={handleChangePassword}
                                    className="btn-primary w-full text-base py-2.5 flex items-center justify-center space-x-1.5 space-x-reverse mb-4"
                                    disabled={isPasswordChanging}
                                >
                                    {isPasswordChanging ? (
                                    <>
                                        <svg className="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        <span>جاري التغيير...</span>
                                    </>
                                    ) : (
                                    <span>تغيير كلمة المرور</span>
                                    )}
                                </button>
                                <button
                                    onClick={() => { setForgotPasswordMode(true); setOldPassword(''); setConfirmNewPassword(''); }}
                                    className="btn-secondary w-full text-base py-2.5"
                                >
                                    نسيت كلمة المرور؟
                                </button>
                            </>
                        ) : (
                            <>
                                <div className="mb-4">
                                    <label className="block font-semibold mb-1" htmlFor="reset-email">
                                        البريد الإلكتروني:
                                    </label>
                                    <input
                                        type="email"
                                        id="reset-email"
                                        value={currentUser?.email || ''}
                                        readOnly
                                        className="w-full opacity-75 cursor-not-allowed"
                                    />
                                </div>
                                <button
                                    onClick={handleSendPasswordResetEmail}
                                    className="btn-primary w-full text-base py-2.5 flex items-center justify-center space-x-1.5 space-x-reverse mb-4"
                                    disabled={isSendingResetEmail || resetEmailSent}
                                >
                                    {isSendingResetEmail ? (
                                    <>
                                        <svg className="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        <span>جاري الإرسال...</span>
                                    </>
                                    ) : resetEmailSent ? (
                                        <span>تم إرسال الرابط!</span>
                                    ) : (
                                        <span>إرسال رابط إعادة تعيين كلمة المرور</span>
                                    )}
                                </button>
                                {resetEmailSent && (
                                    <p className="text-sm text-gray-400 text-center mb-4">
                                        تم إرسال رابط إعادة تعيين كلمة المرور إلى بريدك الإلكتروني. يرجى التحقق من صندوق الوارد الخاص بك (وقسم الرسائل غير المرغوب فيها).
                                    </p>
                                )}
                                <div className="mb-4">
                                    <label className="block font-semibold mb-1" htmlFor="verification-code">
                                        رمز التحقق (من البريد الإلكتروني):
                                    </label>
                                    <input
                                        type="text"
                                        id="verification-code"
                                        value={verificationCode}
                                        onChange={(e) => setVerificationCode(e.target.value)}
                                        className="w-full"
                                        placeholder="أدخل رمز التحقق"
                                        required
                                        autoComplete="off"
                                    />
                                </div>
                                <div className="mb-4 password-input-container">
                                    <label className="block font-semibold mb-1" htmlFor="new-password-reset">
                                        كلمة المرور الجديدة:
                                    </label>
                                    <input
                                        type={showResetNewPassword ? "text" : "password"}
                                        id="new-password-reset"
                                        value={newPassword}
                                        onChange={(e) => setNewPassword(e.target.value)}
                                        className="w-full"
                                        placeholder="أدخل كلمة المرور الجديدة"
                                        required
                                        autoComplete="new-password"
                                    />
                                    <button
                                        type="button"
                                        onClick={() => setShowResetNewPassword(prev => !prev)}
                                        className="password-toggle-button"
                                    >
                                        {showResetNewPassword ? (
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-eye-off"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.54 18.54 0 0 1 2.21-3.02M5.07 5.07A10.91 10.91 0 0 1 8 4c7 0 11 8 11 8a18.54 18.54 0 0 1-2.21 3.02M9.36 10.64a3 3 0 1 0 4.24 4.24M1 1l22 22"/></svg>
                                        ) : (
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-eye"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                                        )}
                                    </button>
                                </div>
                                <div className="mb-6 password-input-container">
                                    <label className="block font-semibold mb-1" htmlFor="confirm-new-password-reset">
                                        تأكيد كلمة المرور الجديدة:
                                    </label>
                                    <input
                                        type={showResetConfirmNewPassword ? "text" : "password"}
                                        id="confirm-new-password-reset"
                                        value={confirmNewPassword}
                                        onChange={(e) => setConfirmNewPassword(e.target.value)}
                                        className="w-full"
                                        placeholder="أعد إدخال كلمة المرور الجديدة"
                                        required
                                        autoComplete="new-password"
                                    />
                                    <button
                                        type="button"
                                        onClick={() => setShowResetConfirmNewPassword(prev => !prev)}
                                        className="password-toggle-button"
                                    >
                                        {showResetConfirmNewPassword ? (
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-eye-off"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.54 18.54 0 0 1 2.21-3.02M5.07 5.07A10.91 10.91 0 0 1 8 4c7 0 11 8 11 8a18.54 18.54 0 0 1-2.21 3.02M9.36 10.64a3 3 0 1 0 4.24 4.24M1 1l22 22"/></svg>
                                        ) : (
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-eye"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                                        )}
                                    </button>
                                </div>
                                <button
                                    onClick={handleVerifyCodeAndResetPassword}
                                    className="btn-primary w-full text-base py-2.5 flex items-center justify-center space-x-1.5 space-x-reverse mb-4"
                                    disabled={isVerifyingCode}
                                >
                                    {isVerifyingCode ? (
                                    <>
                                        <svg className="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        <span>جاري التحقق...</span>
                                    </>
                                    ) : (
                                    <span>إعادة تعيين كلمة المرور</span>
                                    )}
                                </button>
                                <button
                                    onClick={() => { setForgotPasswordMode(false); setResetEmailSent(false); setOldPassword(''); setNewPassword(''); setConfirmNewPassword(''); setVerificationCode(''); }}
                                    className="btn-secondary w-full text-base py-2.5"
                                >
                                    العودة لتغيير كلمة المرور
                                </button>
                            </>
                        )}
                    </>
                ) : (
                    <p className="text-gray-400 text-center">
                        لا يمكنك تغيير كلمة المرور هنا لأن حسابك لم يتم إنشاؤه ببريد إلكتروني وكلمة مرور (على سبيل المثال، تم تسجيل الدخول باستخدام حساب Google أو كضيف).
                    </p>
                )}
              </div>
            )}
          </main>

          <ScrollToTopButton />
          <Footer />
          {modal && <CustomModal message={modal.message} type={modal.type} onClose={() => setModal(null)} />}
        </div>
      );
    };

    // عرض مكون التطبيق في الجذر
    window.renderApp = (user) => {
        const initialLoadingScreen = document.getElementById('initial-loading');
        if (initialLoadingScreen) {
            initialLoadingScreen.style.display = 'none';
        }
        ReactDOM.render(<ProfilePage currentUser={user} />, document.getElementById('root'));
    };

    // شاشة تحميل أولية
    ReactDOM.render(
      <div id="initial-loading" class="flex flex-col items-center justify-center min-h-screen">
          <div class="loading-spinner"></div>
          <p class="text-xl text-gray-300 mt-2">جاري التحقق من تسجيل الدخول...</p>
      </div>,
      document.getElementById('root')
    );
  </script>
</body>
</html>

