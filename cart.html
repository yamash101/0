<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>منتجاتك المختارة – ميركاتو | تسوق بذكاء، عش أفضل</title>
  <!-- أيقونة المفضلة -->
  <link rel="icon" href="favicon.ico" type="image/x-icon" />

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- خطوط Google لـ Cairo -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;700;800;900&display=swap" rel="stylesheet" />

  <style>
    /* لوحة الألوان الفاخرة الجديدة (الوضع الليلي الدائم): */
    /* Primary Dark: #1A2C42 (كحلي عميق / أزرق داكن) */
    /* Accent Gold: #D4AF37 (ذهبي / برونزي) */
    /* Light Background (تستخدم الآن كلون نص): #F8F8F8 (رمادي فاتح جداً / كريمي) */
    /* Secondary Accent: #5A7D9D (أزرق باهت / تيل) */
    /* Background Darkest: #0F1A2A */
    /* Header Background Darker: #0B141F */
    /* Card Background Dark: #1F2E40 */
    /* Skeleton Loader Dark: #2C3E50, #34495E */

    body {
      font-family: 'Cairo', sans-serif;
      background: #0F1A2A; /* خلفية داكنة ثابتة */
      color: #F8F8F8; /* لون النص الأساسي الفاتح */
      line-height: 1.6;
      text-align: right;
      font-size: 0.625rem; /* ~78% من 0.8rem، لتقليص العناصر الأخرى بشكل فعال */

      /* Make body the flex container for fixed header/footer and scrollable content */
      display: flex;
      flex-direction: column;
      height: 100vh; /* Full viewport height */
      overflow: hidden; /* Prevent body scroll, let inner content scroll */
    }

    /* أحجام الخطوط في Tailwind - للحفاظ على أحجام النصوص جيدة */
    .text-xs { font-size: 0.7rem; }
    .text-sm { font-size: 0.8rem; }
    .text-base { font-size: 0.9rem; }
    .text-lg { font-size: 1.05rem; }
    .text-xl { font-size: 1.25rem; }
    .text-2xl { font-size: 1.5rem; }
    .text-3xl { font-size: 1.875rem; }
    .text-4xl { font-size: 2.25rem; }
    .text-5xl { font-size: 2.5rem; }
    .text-6xl { font-size: 3rem; }
    .text-7xl { font-size: 3.75rem; }

    /* أنماط شاشة التحميل العام */
    .loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #0F1A2A;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        color: #F8F8F8;
    }
    .loading-spinner {
        border: 3.6px solid #2C3E50;
        border-top: 3.6px solid #D4AF37;
        border-radius: 50%;
        width: 22.5px;
        height: 22.5px;
        animation: spin 1s linear infinite;
        margin-bottom: 6.75px;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* حاويات عامة لضمان ألا يوجد شريط تمرير أفقي */
    .container {
      max-width: 576px; /* للحفاظ على عرض الهاتف */
      margin: 0 auto;
      padding: 0 0.8rem;
    }

    /* أنماط خاصة بالرأس */
    .header-bg {
      background: #0B141F;
      border-bottom: 1px solid rgba(212, 175, 55, 0.5);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    /* أزرار بلمسة ذهبية */
    .btn-primary {
      background-color: #D4AF37;
      color: #1A2C42;
      font-weight: 800;
      padding: 0.4rem 1.3rem;
      border-radius: 9999px;
      box-shadow: 0 2.5px 6.5px rgba(212, 175, 55, 0.4);
      transition: all 0.3s ease;
      font-size: 0.7rem;
    }
    .btn-primary:hover {
      background-color: #C29B27;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(212, 175, 55, 0.6);
    }
    .btn-secondary {
      background-color: transparent;
      border: 1px solid #D4AF37;
      color: #D4AF37;
      font-weight: 700;
      padding: 0.35rem 1.2rem;
      border-radius: 9999px;
      transition: all 0.3s ease;
      font-size: 0.7rem;
    }
    .btn-secondary:hover {
      background-color: #D4AF37;
      color: #1A2C42;
      transform: translateY(-0.7px);
      box-shadow: 0 1.5px 4.5px rgba(212, 175, 55, 0.3);
    }

    /* أنماط المودال المخصصة (بدلاً من alert) */
    .custom-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .custom-modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }
    .custom-modal-content {
      background-color: #1F2E40;
      color: #F8F8F8;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.4);
      max-width: 270px;
      width: 90%;
      text-align: center;
      transform: translateY(-12px);
      opacity: 0;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }
    .custom-modal-overlay.show .custom-modal-content {
      transform: translateY(0);
      opacity: 1;
    }
    .custom-modal-content .p-4 { padding: 10px; border-radius: 6px; }
    .custom-modal-content .text-2xl { font-size: 1.25rem; }
    .custom-modal-content .text-lg { font-size: 0.9rem; }
    .custom-modal-content .bg-green-600 { background-color: #38A169; }
    .custom-modal-content .text-white { color: white; }
    .custom-modal-content .border-green-400 { border-color: #68D391; }
    .custom-modal-content .bg-red-600 { background-color: #C53030; }
    .custom-modal-content .text-red-700 { color: #FEE2E2; }
    .custom-modal-content .border-red-400 { border-color: #F6AD55; }
    .custom-modal-content .bg-[#D4AF37] { background-color: #D4AF37; color: #1A2C42; }
    .custom-modal-content .hover:bg-[#C29B27]:hover { background-color: #C29B27; }
    .custom-modal-content .shadow-lg { box-shadow: 0 4px 8px rgba(0,0,0,0.3); }

    /* أنماط زر العودة للأعلى */
    .scroll-to-top {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #D4AF37;
      color: #1A2C42;
      border-radius: 50%;
      padding: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
      z-index: 999;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    .scroll-to-top.show {
      opacity: 1;
      visibility: visible;
    }
    .scroll-to-top:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
    }
    .scroll-to-top svg {
      width: 17px;
      height: 17px;
      stroke-width: 2.5;
    }

    /* أنماط خاصة ببطاقات المنتجات */
    .product-card {
        background-color: #1F2E40;
        border-radius: 12px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.4);
        border: 1px solid #2C3E50;
        padding: 10px;
        margin-bottom: 10px;
        display: flex;
        flex-direction: column; /* جعل العناصر تتكدس عمودياً */
        align-items: center; /* توسيط العناصر أفقياً داخل البطاقة */
        text-decoration: none;
        color: inherit;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        position: relative; /* للسماح بوضع زر الحذف بشكل مطلق */
    }
    .product-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
    }
    .product-image-responsive {
        width: 100%; /* الصورة تأخذ عرض البطاقة كاملاً */
        max-width: 200px; /* تحديد أقصى عرض للصورة على الشاشات الكبيرة */
        height: 150px; /* ارتفاع ثابت للصورة */
        object-fit: contain; /* لتناسب الصورة بالكامل داخل المساحة المحددة */
        border-radius: 8px;
        margin-bottom: 10px; /* مسافة أسفل الصورة */
        background-color: #0F1A2A; /* خلفية لتوضيح حدود الصورة */
    }
    .product-details-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center; /* توسيط المحتوى (الاسم، السعر، الزر) */
        flex-grow: 1;
        width: 100%; /* للتأكد من أن المحتوى يأخذ العرض الكامل للتوسيط */
    }
    .product-info {
        text-align: center; /* توسيط النص داخل معلومات المنتج */
        margin-bottom: 10px; /* مسافة بين المعلومات والزر */
        width: 100%;
    }
    .product-name {
        font-weight: bold;
        font-size: 0.9rem;
        color: #F8F8F8;
        margin-bottom: 5px;
    }
    .product-price {
        font-size: 0.8rem;
        color: #D4AF37;
    }
    .buy-button {
        background-color: #D4AF37;
        color: #1A2C42;
        font-weight: 800;
        padding: 0.4rem 1.3rem;
        border-radius: 9999px;
        box-shadow: 0 2.5px 6.5px rgba(212, 175, 55, 0.4);
        transition: all 0.3s ease;
        font-size: 0.7rem;
        text-decoration: none; /* إزالة خط الرابط */
        display: inline-block; /* للسماح بالـ padding والانتقالات */
        margin-top: 5px; /* مسافة أعلى الزر */
    }
    .buy-button:hover {
        background-color: #C29B27;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(212, 175, 55, 0.6);
    }
    .remove-item-btn {
        position: absolute;
        top: 10px;
        left: 10px; /* ليكون في الزاوية اليسرى العلوية */
        background-color: #C53030;
        color: #F8F8F8;
        border: none;
        width: 25px;
        height: 25px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        transition: background-color 0.2s;
        cursor: pointer;
        z-index: 10;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    .remove-item-btn:hover {
        background-color: #9B2C2C;
        transform: scale(1.05);
    }

    /* قسم الملخص */
    .summary-card {
        background-color: #1F2E40;
        border-radius: 12px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.4);
        border: 1px solid #2C3E50;
        padding: 15px;
        margin-bottom: 20px; /* تم تغييرها لتبدو فوق المنتجات */
    }
    .summary-card h3 {
        font-size: 1.25rem;
        font-weight: bold;
        color: #D4AF37;
        margin-bottom: 10px;
    }
    .summary-card p {
        font-size: 1rem;
        color: #F8F8F8;
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
    }
  </style>
</head>
<body class="font-cairo antialiased">

  <!-- Google Tag Manager (noscript) - تم الإبقاء عليه كما كان في الكود الأصلي للمستخدم -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KPJ7ZG4R"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- نهاية Google Tag Manager (noscript) -->

  <!-- العنصر الجذر لتطبيق React -->
  <div id="root" class="flex flex-col min-h-screen">
    <!-- شاشة التحميل الأولية، ستُعرض بواسطة ReactDOM.render -->
    <div id="initial-loading" class="loading-screen">
        <div class="loading-spinner"></div>
        <p class="text-xl text-gray-300 mt-2">جاري التحقق من تسجيل الدخول...</p>
    </div>
  </div>

  <!-- مكتبات React الأساسية -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- حزم Firebase SDKs -->
  <script type="module">
    // استيراد وحدات Firebase النمطية المطلوبة
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    // إضافة deleteDoc لتمكين حذف الوثائق
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, onSnapshot, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // تكوين Firebase (يُفضل أن يكون من متغيرات البيئة في بيئة Canvas)
    const userProvidedFirebaseConfig = {
      apiKey: "AIzaSyCuttEadee0V2YOZHmG53a2Rck7AvFCFEM",
      authDomain: "mercato-2cf1d.firebaseapp.com",
      projectId: "mercato-2cf1d",
      storageBucket: "mercato-2cf1d.firebasestorage.app",
      messagingSenderId: "896887505927",
      appId: "1:896887505927:web:6cb474409bdcfdb1e216a2",
      measurementId: "G-4WNGK0W077"
    };

    // استخدام __firebase_config إذا كان متاحًا، وإلا استخدم userProvidedFirebaseConfig
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : userProvidedFirebaseConfig;
    // استخدام __app_id إذا كان متاحًا، وإلا استخدم projectId من firebaseConfig كافتراضي
    const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
    window.mercatoAppId = appId; // جعل معرف التطبيق متاحًا عالميًا

    // تهيئة Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // جعل مثيلات Firebase ووظائفها متاحة عالمياً لمكونات React
    window.firebaseApp = app;
    window.firebaseAuth = auth;
    window.firebaseFirestore = {
      dbInstance: db,
      getFirestore: getFirestore,
      collection: collection,
      doc: doc,
      getDoc: getDoc,
      setDoc: setDoc,
      updateDoc: updateDoc,
      onSnapshot: onSnapshot,
      serverTimestamp: serverTimestamp,
      deleteDoc: deleteDoc // إضافة deleteDoc هنا
    };
    window.firebaseAuthInstance = auth; // جعل مثيل المصادقة متاحًا عالميًا لتسجيل الخروج

    // تهيئة المصادقة لبيئة Canvas - دائماً سجل الدخول، إما برمز مخصص أو كمجهول
    async function initializeAuthForCanvas() {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          // إذا كان هناك رمز مصادقة أولي من Canvas، استخدمه
          await signInWithCustomToken(auth, __initial_auth_token);
          console.log("Firebase: Signed in with custom token.");
        } else {
          // إذا لم يكن هناك، قم بتسجيل الدخول كمستخدم مجهول
          await signInAnonymously(auth);
          console.log("Firebase: Signed in anonymously.");
        }
      } catch (error) {
        console.error("خطأ في تهيئة مصادقة Firebase:", error);
      }
    }

    // مستمع حالة المصادقة الرئيسي
    // هذا سيتم تشغيله عند أي تغيير في حالة المصادقة (تسجيل دخول، تسجيل خروج، تحميل أولي)
    onAuthStateChanged(auth, (user) => {
      // إخفاء شاشة التحميل الأولية بمجرد تحديد حالة المصادقة
      const initialLoadingScreen = document.getElementById('initial-loading');
      if (initialLoadingScreen) {
        initialLoadingScreen.style.display = 'none';
      }

      // التحقق من تسجيل الدخول: إذا لم يكن هناك مستخدم أو كان مجهولاً، قم بإعادة التوجيه
      if (!user || user.isAnonymous) {
        console.log("Firebase Auth State Changed. No user logged in or is anonymous. Redirecting to login.html...");
        window.location.href = 'login.html'; // إعادة التوجيه إلى صفحة تسجيل الدخول
      } else {
        console.log("Firebase Auth State Changed. User UID:", user.uid);
        if (window.renderApp) {
          window.renderApp(user); // تمرير كائن المستخدم إلى تطبيق React
        } else {
          console.error("Window.renderApp is not defined. React app might not be loaded yet.");
        }
      }
    });

    // ابدأ عملية تهيئة المصادقة فورًا عند تحميل السكريبت
    initializeAuthForCanvas();

    // دالة تسجيل الخروج العالمية
    window.handleSignOut = async () => {
      try {
        await signOut(window.firebaseAuthInstance); // استخدام المثيل العالمي
        // بعد تسجيل الخروج، سيقوم مستمع onAuthStateChanged بإعادة التوجيه
      } catch (error) {
        console.error("حدث خطأ أثناء تسجيل الخروج: ", error);
        // استخدام نافذة مودال مخصصة بدلاً من alert()
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[1000]';
        modal.innerHTML = `
          <div class="bg-white p-2 rounded-sm shadow-md text-center max-w-[150px]">
            <h3 class="text-sm font-bold text-red-600 mb-2">خطأ في تسجيل الخروج</h3>
            <p class="text-xs text-gray-700">${error.message || "حدث خطأ أثناء تسجيل الخروج. يرجى المحاولة مرة أخرى."}</p>
            <button class="mt-2 bg-[#1A2C42] text-white px-2 py-1 text-xs rounded-sm hover:bg-gray-800 transition-colors" onclick="this.parentNode.parentNode.remove()">حسناً</button>
          </div>
        `;
        document.body.appendChild(modal);
      }
    };
  </script>

  <script type="text/babel">
    const useState = React.useState;
    const useEffect = React.useEffect;
    const useCallback = React.useCallback;

    // --- Custom Modal Component ---
    const CustomModal = ({ title, message, type, onClose }) => {
      const isSuccess = type === 'success';
      const bgColorClass = isSuccess ? 'bg-green-600' : 'bg-red-600';
      const textColorClass = 'text-white';

      const [showModal, setShowModal] = useState(false);

      useEffect(() => {
        const timer = setTimeout(() => setShowModal(true), 50); 
        return () => clearTimeout(timer);
      }, []);

      const handleClose = () => {
        setShowModal(false);
        setTimeout(onClose, 300); 
      };

      return (
        <div className={`custom-modal-overlay ${showModal ? 'show' : ''}`}>
          <div className={`custom-modal-content ${showModal ? 'show' : ''}`}>
            <div className={`p-4 rounded-lg ${bgColorClass} ${textColorClass} mb-3`}>
              <h3 className="text-xl font-bold mb-2">{title}</h3>
              <p className="text-sm">{message}</p>
            </div>
            <button
              onClick={handleClose}
              className="bg-[#D4AF37] text-[#1A2C42] font-bold py-2 px-6 rounded-full hover:bg-[#C29B27] transition-colors duration-300 shadow-sm text-sm"
            >
              حسناً
            </button>
          </div>
        </div>
      );
    };

    // --- Header Component (Updated for Cart Page) ---
    const Header = ({ currentUser }) => {
        const [cartItemCount, setCartItemCount] = useState(0);

        useEffect(() => {
            let unsubscribeCart = () => {};
            if (currentUser && currentUser.uid && window.firebaseFirestore && window.firebaseFirestore.onSnapshot) {
                const dbInstance = window.firebaseFirestore.getFirestore();
                const userCartCollectionRef = window.firebaseFirestore.collection(
                    dbInstance,
                    'artifacts',
                    window.mercatoAppId, 
                    'users',
                    currentUser.uid,
                    'cartItems'
                );
                console.log("Header: Listening to cart changes at:", userCartCollectionRef.path);

                unsubscribeCart = window.firebaseFirestore.onSnapshot(userCartCollectionRef, (snapshot) => {
                    let totalCount = 0;
                    snapshot.forEach(doc => {
                        const itemData = doc.data();
                        totalCount += itemData.quantity || 0; // Sum quantities if available, else count as 1
                    });
                    setCartItemCount(totalCount);
                    console.log("Header: Cart items updated. Total:", totalCount);
                }, (error) => {
                    console.error("Header: Error fetching cart items:", error);
                    // Optionally show a modal here, but might be too frequent for header
                });
            } else {
                setCartItemCount(0);
                console.log("Header: Not listening to cart (no user or Firebase not ready).");
            }

            return () => unsubscribeCart();
        }, [currentUser]); // Re-run effect if currentUser changes

        const handleGoBack = () => {
            history.back();
        };

        return (
            <header className="header-bg text-white p-1.5 shadow-sm rounded-b-md z-50">
            <div className="container mx-auto flex flex-wrap items-center justify-between py-1">
                {/* الشعار والعنوان (يمين) */}
                <div className="flex items-center space-x-1.5 space-x-reverse">
                <img
                    src="https://i.postimg.cc/kGPQ7cK1/Screenshot-Canva.jpg" /* Updated logo URL */
                    alt="ميركاتو"
                    className="w-auto h-8 object-contain rounded-sm shadow-xs border border-[#D4AF37]"
                    onError={(e) => {
                    e.target.onerror = null;
                    e.target.src = 'https://placehold.co/32x16/1A2C42/D4AF37?text=ميركاتو';
                    }}
                />
                <div className="flex flex-col">
                    <h1 className="text-2xl font-extrabold text-white leading-tight">
                    ميركاتو
                    </h1>
                    <p className="text-xs text-[#D4AF37] mt-0.25 font-light tracking-wide">
                    أفضل العروض، بأقل جهد!
                    </p>
                </div>
                </div>

                {/* قائمة التنقل الرئيسية (المنتصف) */}
                <nav className="flex items-center space-x-2 space-x-reverse text-xs font-semibold flex-grow justify-center">
                <a href="index.html" className="hover:text-[#D4AF37] transition-colors p-0.5 rounded-xs hover:bg-white hover:bg-opacity-10">
                    الرئيسية
                </a>
                <a href="all-categories.html" className="hover:text-[#D4AF37] transition-colors p-0.5 rounded-xs hover:bg-white hover:bg-opacity-10">
                    أقسامنا
                </a>
                <a href="daily-deals.html" className="hover:text-[#D4AF37] transition-colors p-0.5 rounded-xs hover:bg-white hover:bg-opacity-10">
                    عروض اليوم
                </a>
                <a href="faq.html" className="hover:text-[#D4AF37] transition-colors p-0.5 rounded-xs hover:bg-white hover:bg-opacity-10">
                    الأسئلة الشائعة
                </a>
                <a href="contact.html" className="hover:text-[#D4AF37] transition-colors p-0.5 rounded-xs hover:bg-white hover:bg-opacity-10">
                    اتصل بنا
                </a>
                </nav>

                {/* أزرار الملف الشخصي/تسجيل الخروج (أقصى اليسار) */}
                <div className="flex items-center space-x-1.5 space-x-reverse">
                    {/* Removed Cart Button */}
                    
                    {/* زر الملف الشخصي */}
                    <div className="relative group">
                    <a href="profile.html" className="flex items-center text-white font-bold py-1 px-2 rounded-full bg-[#5A7D9D] hover:bg-[#D4AF37] hover:text-[#1A2C42] transition-colors duration-300 shadow-xs text-xs">
                        <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-user-circle ml-0.5">
                            <circle cx="12" cy="12" r="10"/><circle cx="12" cy="10" r="3"/><path d="M7 20.662V19a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v1.662"/>
                        </svg>
                        الملف الشخصي
                    </a>
                    {/* قائمة منسدلة لتسجيل الخروج */}
                    <div className="absolute right-0 mt-0.5 w-24 bg-[#1F2E40] text-gray-200 rounded-sm shadow-sm opacity-0 group-hover:opacity-100 group-hover:visible transition-all duration-300 transform scale-95 group-hover:scale-100 pointer-events-none group-hover:pointer-events-auto text-xs">
                        <a href="#" onClick={window.handleSignOut} className="block px-1.5 py-1 hover:bg-[#2C3E50] rounded-xs text-red-400 font-semibold">
                        تسجيل الخروج
                        </a>
                    </div>
                    </div>

                    {/* زر الرجوع */}
                    <button
                        onClick={handleGoBack}
                        className="p-1.5 rounded-full hover:bg-white hover:bg-opacity-10 transition-colors flex items-center justify-center text-[#D4AF37] focus:outline-none focus:ring-1 focus:ring-[#D4AF37]"
                        aria-label="الرجوع"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-arrow-right-from-line transform rotate-180"><path d="M3 5V19"/><path d="M17 12H3"/><path d="m14 5 3 7-3 7"/></svg>
                    </button>
                </div>
            </div>
            </header>
        );
    };

    // --- Product Card Component ---
    const ProductCard = ({ item, onRemoveItem }) => {
      // استخدم product.displayPrice مباشرة، مع التأكد من تحويله لرقم إذا لزم الأمر
      const itemPrice = parseFloat(String(item.displayPrice || '0').replace(/[^\d.]/g, '')) || 0;

      return (
        <div className="product-card">
          <button onClick={() => onRemoveItem(item.id)} className="remove-item-btn" aria-label="Remove item"> {/* Use item.id for Firestore document ID */}
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
          </button>
          <img
            src={item.img || `https://placehold.co/200x150/1F2E40/D4AF37?text=صورة`}
            alt={item.name}
            className="product-image-responsive"
            onError={(e) => { e.target.onerror = null; e.target.src = 'https://placehold.co/200x150/1F2E40/D4AF37?text=صورة'; }}
          />
          <div className="product-details-wrapper">
            <div className="product-info">
              <h3 className="product-name">{item.name}</h3>
              <p className="product-price">{itemPrice.toFixed(2)} ر.س</p>
            </div>
            <a href={item.link || '#'} target="_blank" rel="noopener noreferrer" className="buy-button">
              اشتري الآن
            </a>
          </div>
        </div>
      );
    };

    // --- Skeleton Loader for Product Card ---
    const ProductCardSkeleton = () => (
      <div className="product-card animate-pulse">
        <div className="w-full max-w-[200px] h-[150px] bg-[#2C3E50] rounded-md mb-2"></div>
        <div className="product-details-wrapper">
          <div className="product-info">
            <div className="h-4 bg-[#34495E] rounded w-3/4 mb-1"></div>
            <div className="h-3 bg-[#34495E] rounded w-1/2"></div>
          </div>
          <div className="h-8 bg-[#34495E] rounded-full w-24"></div>
        </div>
      </div>
    );

    // --- Scroll to Top Button Component ---
    const ScrollToTopButton = () => {
      const [isVisible, setIsVisible] = useState(false);

      const toggleVisibility = () => {
        const mainContent = document.querySelector('.main-scroll-content');
        if (mainContent && mainContent.scrollTop > 300) {
          setIsVisible(true);
        } else {
          setIsVisible(false);
        }
      };

      const scrollToTop = () => {
        const mainContent = document.querySelector('.main-scroll-content');
        if (mainContent) {
          mainContent.scrollTo({
            top: 0,
            behavior: 'smooth'
          });
        }
      };

      useEffect(() => {
        const mainContent = document.querySelector('.main-scroll-content');
        if (mainContent) {
          mainContent.addEventListener('scroll', toggleVisibility);
          return () => mainContent.removeEventListener('scroll', toggleVisibility);
        }
      }, []);

      return (
        <button
          onClick={scrollToTop}
          className={`scroll-to-top ${isVisible ? 'show' : ''}`}
          aria-label="العودة للأعلى"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-arrow-up"><path d="m5 12 7-7 7 7"/><path d="M12 19V5"/></svg>
        </button>
      );
    };

    // --- Footer Component ---
    const Footer = () => {
      return (
        <footer className="bg-[#0B141F] text-white py-6 px-1.5 mt-10 rounded-t-md shadow-inner-dark z-30">
          <div className="container mx-auto grid grid-cols-1 md:grid-cols-3 gap-2.5 text-center md:text-right">
            {/* Removed Contact Information */}
            {/* Removed Quick Links */}

            {/* تابعنا */}
            <div className="animate-fade-in-up animation-delay-400 col-span-full md:col-span-1"> {/* Adjusted column span for centering */}
              <h3 className="text-base font-bold mb-1.5 text-[#D4AF37]">تابعنا</h3>
              <div className="flex justify-center md:justify-end space-x-2.5 space-x-reverse">
                <a
                  href="https://www.tiktok.com/@mercato.0"
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-gray-400 hover:text-[#D4AF37] transition-colors transform hover:scale-110 duration-300 text-xs"
                  aria-label="TikTok"
                >
                  TIKTOK
                </a>
                <a
                  href="https://www.instagram.com/mercato.0?igsh=MWRvangxbHdqcXA0bQ=="
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-gray-400 hover:text-[#D4AF37] transition-colors transform hover:scale-110 duration-300 text-xs"
                  aria-label="Instagram"
                >
                  Instagram
                </a>
                <a
                  href="https://t.me/mercato00"
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-gray-400 hover:text-[#D4AF37] transition-colors transform hover:scale-110 duration-300 text-xs"
                  aria-label="Telegram"
                >
                  Telegram
                </a>
                <a
                  href="https://www.facebook.com/yourpage" /* Placeholder for Facebook link */
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-gray-400 hover:text-[#D4AF37] transition-colors transform hover:scale-110 duration-300 text-xs"
                  aria-label="Facebook"
                >
                  FACEBOOK
                </a>
              </div>
            </div>
          </div>
          <div className="border-t border-gray-600 mt-3.5 pt-3.5 text-center text-gray-500 text-xs">
            <p>&copy; 2025 ميركاتو. جميع الحقوق محفوظة.</p>
            <p className="mt-1">مصمم بحب لتقديم أفضل تجربة تسوق.</p>
          </div>
        </footer>
      );
    };

    // --- Main App Component ---
    const App = ({ currentUser }) => {
      const [products, setProducts] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [modalInfo, setModalInfo] = useState(null); // State for CustomModal
      
      // State for user country, initialized from localStorage or default 'SA'
      // This is important for consistency across pages
      const [userCountry, setUserCountry] = useState(() => localStorage.getItem('mercato_selected_country') || 'SA');

      // Function to display a custom modal (replaces alert/confirm)
      const showModal = useCallback((title, message, isError = false) => {
        setModalInfo({ title, message, type: isError ? 'error' : 'success', onClose: () => setModalInfo(null) });
      }, []); 

      // Listen for real-time updates to user profile document for country
      useEffect(() => {
        let unsubscribeProfile = () => {};
        if (currentUser && currentUser.uid && window.firebaseFirestore) {
          const dbInstance = window.firebaseFirestore.getFirestore();
          const userProfileDocRef = window.firebaseFirestore.doc(
            dbInstance,
            'artifacts',
            window.mercatoAppId,
            'users',
            currentUser.uid,
            'userProfiles',
            'profile'
          );

          unsubscribeProfile = window.firebaseFirestore.onSnapshot(userProfileDocRef, async (docSnap) => {
            if (docSnap.exists()) {
              const data = docSnap.data();
              const fetchedCountry = data.country || 'SA'; 
              if (fetchedCountry !== userCountry) {
                setUserCountry(fetchedCountry);
                localStorage.setItem('mercato_selected_country', fetchedCountry);
              }
            } else {
              // Profile doesn't exist, create it with default country
              const defaultCountry = 'SA';
              await window.firebaseFirestore.setDoc(userProfileDocRef, {
                email: currentUser.email || 'anonymous@mercato.com', 
                createdAt: window.firebaseFirestore.serverTimestamp(),
                country: defaultCountry,
                name: ''
              }, { merge: true });
              setUserCountry(defaultCountry);
              localStorage.setItem('mercato_selected_country', defaultCountry);
            }
          }, (error) => {
            console.error("App: Error listening to user profile:", error);
            showModal('خطأ في مزامنة الدولة', 'تعذر تحديث معلومات دولتك تلقائيًا.', true);
          });
        }

        return () => unsubscribeProfile();
      }, [currentUser, showModal, userCountry]); // userCountry as dependency to re-run if it changes locally

      // Fetch products from Firestore - UPDATED TO LISTEN TO CART ITEMS
      useEffect(() => {
        let unsubscribeProducts = () => {};

        if (!currentUser || !currentUser.uid || currentUser.isAnonymous || !window.firebaseFirestore || !window.firebaseFirestore.dbInstance) {
          console.warn("App: Firebase or user not ready or user is anonymous. Cannot fetch cart items.");
          setLoading(false);
          setProducts([]);
          return;
        }

        const userId = currentUser.uid;
        // Reference to the user's specific cartItems collection
        const userCartCollectionRef = window.firebaseFirestore.collection(
          window.firebaseFirestore.dbInstance,
          'artifacts',
          window.mercatoAppId,
          'users',
          userId,
          'cartItems' 
        );

        console.log("App: Subscribing to cart items collection at:", userCartCollectionRef.path);

        unsubscribeProducts = window.firebaseFirestore.onSnapshot(userCartCollectionRef, (snapshot) => {
          const fetchedProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          setProducts(fetchedProducts);
          console.log("App: Fetched", fetchedProducts.length, "products from cartItems collection.");
          setLoading(false);
          setError(null);
        }, (err) => {
          console.error("App: Error fetching products from Firestore:", err);
          setError("فشل تحميل المنتجات. يرجى المحاولة مرة أخرى.");
          setLoading(false);
        });

        return () => unsubscribeProducts(); // Clean up listener
      }, [currentUser]); // Re-run effect if currentUser changes

      // Handle removing a product - UPDATED TO DELETE A DOCUMENT
      const handleRemoveItem = async (productId) => { // productId is now the document ID
        if (!currentUser || !currentUser.uid || currentUser.isAnonymous) {
            showModal('خطأ في المصادقة', 'الرجاء تسجيل الدخول لإزالة المنتجات.', true);
            return;
        }

        try {
          const userId = currentUser.uid;
          // Reference to the specific document to delete within the 'cartItems' collection
          const productDocRef = window.firebaseFirestore.doc(
            window.firebaseFirestore.dbInstance,
            'artifacts',
            window.mercatoAppId,
            'users',
            userId,
            'cartItems',
            productId // This is the document ID to delete
          );
          console.log("Attempting to delete product document:", productDocRef.path);

          await window.firebaseFirestore.deleteDoc(productDocRef);
          showModal('تمت الإزالة!', 'تم حذف المنتج بنجاح.', false); // 'false' for success type

        } catch (error) {
          console.error("خطأ في إزالة المنتج:", error);
          showModal('فشل الإزالة', `فشل إزالة المنتج: ${error.message}`, true); // 'true' for error type
        }
      };

      const totalProductsCount = products.length; // This will be passed to Header

      if (loading) {
        return (
          <div className="loading-screen">
              <div className="loading-spinner"></div>
              <p className="text-xl text-gray-300 mt-2">جاري تحميل المنتجات...</p>
          </div>
        );
      }

      if (error && products.length === 0) { 
        return (
          <div className="text-center p-3.5 bg-red-50 border border-red-300 text-red-700 rounded-md shadow-sm my-3.5 mx-auto max-w-xs">
            <p className="text-base font-bold mb-1.5">عفواً، حدث خطأ!</p>
            <p className="text-xs">{error}</p>
            <p className="mt-1.5 text-gray-400">
              يرجى التأكد من اتصالك بالإنترنت أو تحديث الصفحة.
            </p>
          </div>
        );
      }
      
      if (products.length === 0) { 
        return (
          <div dir="rtl" className="flex flex-col min-h-screen">
            <Header currentUser={currentUser} /> {/* Pass currentUser to Header */}
            <div className="flex-grow overflow-y-auto main-scroll-content">
                <main className="container mx-auto my-6 px-2.5 relative z-30">
                {/* Product Summary (moved to top) */}
                <div className="summary-card mt-8 text-center">
                    <h3 className="mb-4">ملخص المنتجات</h3>
                    <p>
                    <span>عدد المنتجات المختارة:</span>
                    <span className="font-bold">{totalProductsCount}</span>
                    </p>
                </div>

                <h2 className="text-4xl font-extrabold text-[#F8F8F8] text-center mb-6 mt-12">
                    المنتجات المختارة
                </h2>
                <div className="text-center p-3.5 bg-[#1F2E40] border border-[#2C3E50] text-white rounded-md shadow-sm my-3.5 mx-auto max-w-xs flex flex-col items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-package-x text-gray-400 mb-1.5"><path d="M21 10V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v6a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 14z"/><path d="m3 7 9 5 9-5"/><path d="m3 14 9 5 9-5"/><path d="m8 8 8 8"/><path d="m16 8-8 8"/></svg>
                    <p className="text-base font-bold mb-1.5">لا توجد منتجات مختارة!</p>
                    <p className="text-xs leading-relaxed">
                    ابدأ باستكشاف منتجاتنا لإضافة بعضها هنا.
                    </p>
                    <a href="index.html" className="btn-primary mt-3 text-xs">
                    تسوق الآن
                    </a>
                </div>
                </main>
                <Footer />
            </div>
            <ScrollToTopButton />
            {modalInfo && <CustomModal {...modalInfo} />}
          </div>
        );
      }

      return (
        <div dir="rtl" className="flex flex-col min-h-screen">
          <Header currentUser={currentUser} /> {/* Pass currentUser to Header */}
          <div className="flex-grow overflow-y-auto main-scroll-content">
            <main className="container mx-auto my-6 px-2.5 relative z-30">
                {/* Product Summary (moved to top) */}
                <div className="summary-card mt-8 text-center">
                    <h3 className="mb-4">ملخص المنتجات</h3>
                    <p>
                    <span>عدد المنتجات المختارة:</span>
                    <span className="font-bold">{totalProductsCount}</span>
                    </p>
                </div>

                <h2 className="text-4xl font-extrabold text-[#F8F8F8] text-center mb-6 mt-12">
                المنتجات المختارة
                </h2>
                
                <div>
                    <div className="grid grid-cols-1 gap-3.5">
                        {products.map((item) => (
                        <ProductCard
                            key={item.id} // Use Firebase document ID as key
                            item={item}
                            onRemoveItem={handleRemoveItem}
                        />
                        ))}
                    </div>
                </div>
            </main>
            <Footer />
          </div>

          <ScrollToTopButton />
          {modalInfo && <CustomModal {...modalInfo} />}
        </div>
      );
    };

    // This function will be called by the Firebase script once auth state is determined
    window.renderApp = (user) => {
        const rootDiv = document.getElementById('root');
        if (rootDiv) {
            ReactDOM.render(<App currentUser={user} />, rootDiv);
        }
    };

    // Render initial loading screen until authentication check is complete
    // This part runs once the DOM is ready, showing the initial loading spinner.
    document.addEventListener('DOMContentLoaded', () => {
        const rootDiv = document.getElementById('root');
        if (rootDiv) {
            ReactDOM.render(
                <div className="loading-screen">
                    <div className="loading-spinner"></div>
                    <p className="text-xl text-gray-300 mt-2">جاري التحقق من تسجيل الدخول...</p>
                </div>,
                rootDiv
            );
        }
    });
  </script>
</body>
</html>

